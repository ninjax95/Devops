---
- name: Clone LXC containers from a reference container
  hosts: all
  become: yes
  vars:
    container_names:
      - server1
      - server2
      - server3
      - server4
      - server5
  tasks:
    - name: Ensure LXC is installed
      apt:
        name: lxc
        state: present

    - name: Clone LXC containers
      loop: "{{ container_names }}"
      command: lxc copy ubuntu {{ item }}
      register: lxc_clone

    - name: Start cloned LXC containers
      loop: "{{ container_names }}"
      command: lxc start {{ item }}
      register: lxc_start

    - name: Wait for the containers to be up
      shell: |
        until lxc list {{ item }} | grep -q RUNNING; do
          sleep 1
        done
      retries: 10
      delay: 5
      loop: "{{ container_names }}"
      register: wait_result
      until: wait_result.rc == 0
      ignore_errors: yes

    - name: Ensure the containers are running
      command: lxc list
      register: lxc_list

    - debug:
        msg: "Cloned LXC containers are launched and running: {{ lxc_list.stdout }}"

    - name: Install Wazuh Agent in each container
      loop: "{{ container_names }}"
      block:
        - name: Download Wazuh Agent package
          shell: wget https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.8.0-1_amd64.deb
          args:
            chdir: /tmp

        - name: Install Wazuh Agent
          shell: |
            WAZUH_MANAGER='10.10.193.187' WAZUH_AGENT_NAME='{{ item }}' dpkg -i /tmp/wazuh-agent_4.8.0-1_amd64.deb
          args:
            chdir: /tmp

        - name: Reload systemd manager configuration
          shell: sudo systemctl daemon-reload

        - name: Enable Wazuh Agent
          shell: sudo systemctl enable wazuh-agent

        - name: Start Wazuh Agent
          shell: sudo systemctl start wazuh-agent
